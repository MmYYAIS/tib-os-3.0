<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç ”æ•°æ® Â· æ™ºèƒ½å·¥ä½œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        paper: '#fffdf5',
                        ink: '#2d2d2d',
                        brand: { DEFAULT: '#db7c00', 50: '#fff8f0', 100: '#ffecd6', 600: '#db7c00', 700: '#b86800' }
                    }
                }
            }
        }
    </script>
    <style>
        .tpe-app {
            background-color: #fffdf5;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .tpe-sketchy-border {
            border: 2px solid #2d2d2d;
            border-radius: 2px 255px 3px 25px / 255px 5px 225px 3px;
        }

        .tpe-btn-sketchy {
            border: 2px solid #2d2d2d;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 2px 3px 0px rgba(0, 0, 0, 0.8);
            transition: all 0.1s ease-in-out;
        }

        .tpe-btn-sketchy:hover {
            box-shadow: 1px 1px 0px rgba(0, 0, 0, 0.8);
            transform: translate(1px, 2px);
        }

        .tpe-btn-sketchy.active {
            background-color: #db7c00;
            color: white;
        }

        .tpe-btn-child {
            border: 2px solid transparent;
            border-bottom: 2px dashed #e2e8f0;
            transition: all 0.1s;
            border-radius: 3px;
            color: #64748b;
        }

        .tpe-btn-child:hover {
            background-color: #f8fafc;
            color: #db7c00;
        }

        .tpe-btn-child.active {
            background-color: #fff8f0;
            color: #db7c00;
            font-weight: bold;
            border: 2px solid #db7c00;
            border-radius: 8px;
        }

        .tpe-card-sketchy {
            border: 2px solid #2d2d2d;
            border-radius: 5px;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
            background: white;
        }

        .tpe-card-sketchy:hover {
            transform: rotate(-1deg) scale(1.02);
            box-shadow: 6px 6px 0px #db7c00;
            z-index: 10;
        }

        .tpe-input-sketchy {
            border: 2px solid #cbd5e1;
            border-radius: 8px 2px 6px 3px;
            background-color: #fff;
        }

        .tpe-input-sketchy:focus {
            border-color: #db7c00;
            outline: none;
            box-shadow: 2px 2px 0px #db7c00;
        }

        .tpe-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .tpe-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }

        .tpe-modal-bg {
            background-color: rgba(45, 45, 45, 0.6);
            backdrop-filter: blur(4px);
        }

        textarea {
            resize: none;
        }
    </style>
</head>

<body class="bg-slate-100 min-h-screen">
    <div
        class="tpe-app w-full max-w-6xl mx-auto tpe-sketchy-border p-1 my-2 md:my-8 flex flex-col min-h-[700px] text-ink shadow-[5px_5px_0px_rgba(0,0,0,0.2)]">
        <div
            class="px-4 py-4 md:px-6 md:py-6 border-b-2 border-dashed border-slate-300 md:flex justify-between items-start bg-paper relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-xs font-black bg-black text-white px-2 py-0.5 transform -rotate-2">OPEN SOURCE
                        LOGIC</span>
                    <h2 class="text-2xl md:text-3xl font-black text-ink">å‹‡éº¦çš„ AI æŠ•èµ„ç³»ç»Ÿ</h2>
                </div>
                <div class="text-slate-600 text-sm md:text-base space-y-1 font-medium leading-relaxed">
                    <p>æŠ•èµ„ä¸åº”è¯¥æ˜¯ç„å­¦ï¼Œè€Œæ˜¯ä¸€ä¸ªå·¥ç¨‹é—®é¢˜ã€‚</p>
                    <p>æˆ‘å·²å°†æ ¸å¿ƒ <strong class="text-brand-600 bg-brand-50 px-1">Prompt æŒ‡ä»¤é›†</strong> ä¸ <strong
                            class="text-brand-600 bg-brand-50 px-1">çŸ¥è¯†åº“æ¶æ„</strong> å®Œå…¨å¼€æºã€‚</p>
                    <p>ä½ å¯ä»¥å…è´¹å¤åˆ¶è¿™å¥—"å¤–éª¨éª¼"ï¼Œåœ¨æ··ä¹±çš„å¸‚åœºä¸­å»ºç«‹ç§©åºã€‚</p>
                </div>
            </div>
            <div
                class="mt-4 md:mt-0 md:text-right hidden md:block opacity-20 transform rotate-3 select-none pointer-events-none">
                <span class="text-6xl">ğŸ§¬</span>
            </div>
        </div>
        <!-- Pro Workbench Header -->
        <div
            class="px-6 py-4 border-b-2 border-dashed border-slate-300 flex justify-between items-center bg-slate-50 relative z-20">
            <div>
                <h2 class="text-xl font-black text-ink flex items-center gap-2">
                    æŠ•ç ”ä¸­çš„å¸¸ç”¨æç¤ºè¯/Prompt
                    <span
                        class="text-sm bg-brand-600 text-white px-2 py-0.5 rounded-full border-2 border-black rotate-2 shadow-[1px_1px_0px_black] text-xs">Pro</span>
                </h2>
                <p class="text-slate-500 mt-1 text-xs md:text-sm">âœ¨ Promptå·¥ä½œå°ï¼šé€‰æ‹©æŒ‡ä»¤ï¼Œè¾“å…¥ç›¸åº”ä¿¡æ¯ã€å¤åˆ¶åå”¤é†’ä½ çš„ AI åˆ†æå¸ˆã€‚</p>
            </div>
        </div>
        <div class="flex flex-col md:flex-row flex-1 overflow-hidden bg-white/50">
            <div class="w-full md:w-64 border-b-2 md:border-b-0 md:border-r-2 border-slate-200 border-dashed flex-shrink-0 flex md:flex-col p-4 gap-2 overflow-x-auto md:overflow-y-auto tpe-scrollbar"
                id="tpe-nav"></div>
            <div class="flex-1 bg-paper p-3 md:p-5 overflow-y-auto tpe-scrollbar relative">
                <div id="tpe-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 pb-20"></div>

                <!-- Footer -->
                <div
                    class="mt-10 pt-6 border-t-2 border-slate-100 border-dashed text-center text-xs text-slate-400 pb-2">
                    <p class="mb-1">æœ¬é¡¹ç›®ä»…å¼€æºæŠ•èµ„é€»è¾‘ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚å¸‚åœºæœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚<br>æ­¤é¡¹ç›®æ—¨åœ¨äº¤æµæŠ•èµ„æ€ç»´ï¼Œä»…é™ä¸ªäººä½¿ç”¨ï¼Œç¦æ­¢è½¬å”®æˆ–å…¶ä»–å•†ä¸šä½¿ç”¨ã€‚</p>
                    <p>ä½œè€…æŠ–éŸ³@å‹‡éº¦</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="tpe-modal" class="fixed inset-0 z-[9999] hidden tpe-modal-bg flex items-center justify-center p-2 md:p-6">
        <div
            class="bg-paper rounded-lg border-4 border-ink shadow-[8px_8px_0px_black] w-full max-w-6xl h-[80vh] flex flex-col overflow-hidden relative">
            <div
                class="px-6 py-4 border-b-2 border-ink border-dashed flex justify-between items-center bg-brand-50 flex-shrink-0">
                <h3 class="font-bold text-xl text-ink flex items-center gap-2 truncate pr-10" id="tpe-modal-title"></h3>
                <button id="tpe-modal-close"
                    class="text-ink hover:text-brand-600 border-2 border-ink rounded-full w-8 h-8 flex items-center justify-center hover:bg-white shadow-[2px_2px_0px_black]">âœ•</button>
            </div>
            <div class="flex-1 overflow-y-auto md:overflow-hidden flex flex-col md:flex-row">
                <div
                    class="w-full md:w-80 bg-slate-50 p-6 border-b-2 md:border-b-0 md:border-r-2 border-slate-200 border-dashed flex-shrink-0 md:overflow-y-auto tpe-scrollbar">
                    <h4 class="text-sm font-black text-slate-500 uppercase mb-5">âœï¸ å˜é‡é…ç½®</h4>
                    <div id="tpe-modal-inputs" class="space-y-5"></div>
                </div>
                <div
                    class="flex-shrink-0 md:flex-1 p-6 flex flex-col bg-paper md:overflow-hidden min-h-[60vh] md:min-h-0">
                    <div class="flex-1 flex flex-col mb-4">
                        <div class="flex justify-between items-end mb-2 flex-wrap gap-2">
                            <h4 class="text-sm font-black text-slate-600 uppercase">ğŸ“ é¢„è§ˆä¸ç¼–è¾‘</h4>
                            <div class="flex items-center gap-2">
                                <select id="tpe-version-select" class="text-xs tpe-input-sketchy px-2 py-1 bg-white">
                                    <option value="default">é»˜è®¤ç‰ˆæœ¬</option>
                                </select>
                                <span
                                    class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 border border-yellow-300 rounded">å¯æ‰‹åŠ¨ä¿®æ”¹</span>
                            </div>
                        </div>
                        <textarea id="tpe-modal-editor"
                            class="flex-1 w-full bg-white tpe-input-sketchy p-5 text-sm text-ink leading-relaxed tpe-scrollbar"
                            spellcheck="false"></textarea>
                    </div>
                    <div
                        class="flex-shrink-0 flex flex-wrap justify-between items-center gap-2 pt-2 border-t-2 border-slate-100 border-dashed">
                        <div class="flex gap-2">
                            <button id="tpe-save-version-btn"
                                class="bg-slate-100 text-slate-700 font-bold py-2 px-4 text-xs tpe-btn-sketchy">ğŸ’¾
                                ä¿å­˜ç‰ˆæœ¬</button>
                            <button id="tpe-reset-btn"
                                class="bg-slate-100 text-slate-700 font-bold py-2 px-4 text-xs tpe-btn-sketchy">ğŸ”„
                                é‡ç½®é»˜è®¤</button>
                            <button id="tpe-delete-version-btn"
                                class="bg-red-50 text-red-600 font-bold py-2 px-4 text-xs tpe-btn-sketchy hidden">ğŸ—‘ï¸
                                åˆ é™¤ç‰ˆæœ¬</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="tpe-copy-feedback" class="text-sm font-bold text-green-600 opacity-0"></span>
                            <button id="tpe-copy-btn"
                                class="bg-brand-600 text-white font-bold py-3 px-8 text-lg tpe-btn-sketchy">ğŸ“‹ å¤åˆ¶
                                Prompt</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/data/prompts.js"></script>
    <script>
        // åˆ†ç±»å®šä¹‰
        const CATEGORIES = [
            { id: "all", name: "å…¨éƒ¨", icon: "ğŸ“š" },
            { id: "å¸‚åœºæ´å¯Ÿ", name: "å¸‚åœºæ´å¯Ÿ", icon: "ğŸ“¡" },
            { id: "ä¸ªè‚¡åˆ†æ", name: "ä¸ªè‚¡åˆ†æ", icon: "ğŸ”¬", children: ["åˆå§‹è°ƒç ”", "åŠ¨æ€çƒ­æ›´æ–°"] },
            { id: "æˆ˜æƒ…åˆ†æ", name: "æˆ˜æƒ…åˆ†æ", icon: "âš”ï¸" },
            { id: "å…³é”®åŠ¨ä½œ", name: "å…³é”®åŠ¨ä½œ", icon: "ğŸ¯", children: ["ä¹°å…¥", "å–å‡º", "æŒæœ‰"] },
            { id: "å…¨å±€ä¸å¤ç›˜", name: "å…¨å±€ä¸å¤ç›˜", icon: "ğŸ“Š" }
        ];

        // çŠ¶æ€
        let activeCategory = "all";
        let currentPromptId = null;
        let currentPromptDefaultText = '';

        // DOM
        const nav = document.getElementById('tpe-nav');
        const grid = document.getElementById('tpe-grid');
        const modal = document.getElementById('tpe-modal');
        const mTitle = document.getElementById('tpe-modal-title');
        const mInputs = document.getElementById('tpe-modal-inputs');
        const mEditor = document.getElementById('tpe-modal-editor');
        const mCloseBtn = document.getElementById('tpe-modal-close');
        const mCopyBtn = document.getElementById('tpe-copy-btn');
        const mCopyFeedback = document.getElementById('tpe-copy-feedback');
        const mVersionSelect = document.getElementById('tpe-version-select');
        const mSaveVersionBtn = document.getElementById('tpe-save-version-btn');
        const mResetBtn = document.getElementById('tpe-reset-btn');
        const mDeleteVersionBtn = document.getElementById('tpe-delete-version-btn');

        // è·å–åˆ†ç±»ä¸‹çš„promptæ•°é‡
        function getPromptCount(catId) {
            if (!window.PROMPTS_DATA) return 0;
            if (catId === "all") return window.PROMPTS_DATA.length;

            // åŒ…å«å­ç±»è®¡æ•°
            const catObj = CATEGORIES.find(c => c.id === catId);
            let targetCats = [catId];
            if (catObj && catObj.children) {
                targetCats = targetCats.concat(catObj.children);
            }

            return window.PROMPTS_DATA.filter(p => p.categories.some(c => targetCats.includes(c))).length;
        }

        // æ¸²æŸ“å¯¼èˆª
        function renderNav() {
            nav.innerHTML = '';
            CATEGORIES.forEach(cat => {
                const count = getPromptCount(cat.id);
                const hasChildren = cat.children && cat.children.length > 0;
                const isActive = activeCategory === cat.id;
                const wrapper = document.createElement('div');
                // Mobile: horizontal item. Desktop: vertical item.
                wrapper.className = 'mb-0 md:mb-2 mr-2 md:mr-0 min-w-[35%] md:min-w-0 flex-shrink-0';

                const btnClass = isActive ? 'tpe-btn-sketchy active' : 'tpe-btn-sketchy bg-white text-slate-700 hover:bg-slate-50';

                wrapper.innerHTML = `<button class="w-full text-left px-3 py-2 md:px-4 md:py-3 text-xs md:text-sm font-bold flex items-center justify-between ${btnClass}" data-cat="${cat.id}">
                <span class="truncate mr-1">${cat.name}</span>
                ${hasChildren ? '<span class="text-slate-400 hidden md:inline">âˆ§</span>' : `<span class="text-xs opacity-50 bg-black/5 px-2 py-0.5 rounded-full transform scale-90 md:scale-100">${count}</span>`}
            </button>`;

                if (hasChildren) {
                    const subMenu = document.createElement('div');
                    // Mobile: Hide submenus (Parent click shows all). Desktop: Show submenus.
                    subMenu.className = 'mt-1 pl-4 space-y-1 hidden md:block';
                    cat.children.forEach(childId => {
                        const childCount = getPromptCount(childId);
                        const isChildActive = activeCategory === childId;
                        const childClass = isChildActive ? 'active' : '';
                        subMenu.innerHTML += `<button class="tpe-btn-child w-full text-left px-4 py-2 text-xs flex items-center justify-between ${childClass}" data-cat="${childId}">
                        <span>${childId}</span><span class="text-[10px] opacity-40">${childCount}</span>
                    </button>`;
                    });
                    wrapper.appendChild(subMenu);
                }
                nav.appendChild(wrapper);
            });
        }

        // è·å–å½“å‰åˆ†ç±»çš„prompts
        function getFilteredPrompts() {
            if (!window.PROMPTS_DATA) return [];
            if (activeCategory === "all") return window.PROMPTS_DATA;

            // åŒ…å«å­ç±»ç­›é€‰
            const catObj = CATEGORIES.find(c => c.id === activeCategory);
            let targetCats = [activeCategory];
            if (catObj && catObj.children) {
                targetCats = targetCats.concat(catObj.children);
            }

            return window.PROMPTS_DATA.filter(p => p.categories.some(c => targetCats.includes(c)));
        }

        // æ¸²æŸ“å¡ç‰‡
        function renderGrid() {
            const prompts = getFilteredPrompts();
            grid.innerHTML = '';
            if (prompts.length === 0) {
                grid.innerHTML = '<div class="col-span-full py-10 opacity-50 italic text-center">æ­¤åˆ†ç±»ä¸‹æš‚æ— æŒ‡ä»¤ã€‚</div>';
                return;
            }
            prompts.forEach(p => {
                const categoryTags = p.categories.map(c => `<span class="text-[10px] bg-brand-50 text-brand-700 px-1.5 py-0.5 rounded border border-brand-200">${c}</span>`).join('');
                const card = document.createElement('div');
                card.className = 'tpe-card-sketchy p-4 cursor-pointer min-h-[160px] flex flex-col relative group';
                card.setAttribute('data-prompt-id', p.id);
                card.innerHTML = `<div class="mb-1 border-b-2 border-slate-100 border-dashed pb-1"><h4 class="font-black text-ink text-base leading-tight truncate" title="${p.title}">${p.title}</h4></div>
                <div class="flex-1 overflow-hidden relative mb-2"><p class="text-xs text-slate-500 leading-snug" style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">${p.desc}</p></div>
                <div class="flex flex-wrap gap-1 mt-auto pt-2 border-t border-slate-100">${categoryTags}</div>`;
                grid.appendChild(card);
            });
        }

        // æŸ¥æ‰¾prompt
        function findPrompt(id) {
            if (!window.PROMPTS_DATA) return null;
            return window.PROMPTS_DATA.find(p => p.id === id);
        }

        // å˜é‡å®šä¹‰ - å·²æ›´æ–°è¦†ç›– P7-P15 éœ€æ±‚
        const INPUT_DEFS = {
            'ticker': { label: 'Ticker æ ‡çš„', ph: 'e.g. NVDA' },
            'price': { label: 'Price ä»·æ ¼/æ•°æ®', ph: 'è¾“å…¥å½“å‰ä»·æ ¼ã€å¸‚å€¼æˆ–ç»“æœ...', type: 'textarea' },
            'sentiment': { label: 'Sentiment æƒ…ç»ª/å®è§‚', ph: 'è¾“å…¥å¸‚åœºæƒ…ç»ªæˆ–å®è§‚èƒŒæ™¯...', type: 'textarea' },
            'event': { label: 'Event äº‹ä»¶å†…å®¹', ph: 'ç²˜è´´æ–°é—»/è´¢æŠ¥/å…¬å‘Šå†…å®¹...', type: 'textarea' },
            'context': { label: 'Context çŸ¥è¯†åº“/æŒä»“', ph: 'ç²˜è´´çŸ¥è¯†åº“ã€æŒä»“æˆ–èƒŒæ™¯ä¿¡æ¯...', type: 'textarea' },
            'notes': { label: 'Notes è¡¥å……è¯´æ˜', ph: 'è¡¥å……è¯´æ˜ã€ç›®æ ‡æˆ–ç†ç”±...', type: 'textarea' },
            'strategy': { label: 'Strategy ç­–ç•¥', ph: 'SOP 1 (PVE) æˆ– SOP 2 (PVP)...', type: 'text' },
            'action': { label: 'Action æ“ä½œæ„å›¾', ph: 'æ‰“ç®—åšä»€ä¹ˆæ“ä½œ...', type: 'textarea' },
            'reason': { label: 'Reason ç†ç”±', ph: 'æ“ä½œèƒŒåçš„é€»è¾‘...', type: 'textarea' }
        };

        // æ¸²æŸ“è¾“å…¥
        function renderModalInputs(reqs) {
            mInputs.innerHTML = '';
            if (!reqs || reqs.length === 0) { mInputs.innerHTML = '<p class="text-slate-400 text-xs text-center py-4 bg-slate-100 rounded border-2 border-dashed">æ— é¢å¤–å˜é‡</p>'; return; }
            reqs.forEach(key => {
                const d = INPUT_DEFS[key];
                // å¦‚æœpromptç”¨äº†æ²¡å®šä¹‰çš„keyï¼Œå°±è·³è¿‡
                if (!d) return;

                const isTextarea = d.type === 'textarea';
                const savedValue = localStorage.getItem(`tpe_var_${key}`) || '';
                const inputEl = isTextarea ? `<textarea class="inp-val w-full tpe-input-sketchy p-3 text-sm h-24" placeholder="${d.ph}">${savedValue}</textarea>` : `<input type="text" class="inp-val w-full tpe-input-sketchy p-3 text-sm" placeholder="${d.ph}" value="${savedValue}">`;
                const div = document.createElement('div');
                div.className = 'inp-group pb-4 border-b-2 border-slate-200 border-dashed last:border-0';
                div.setAttribute('data-key', key);
                div.innerHTML = `<label class="flex items-center gap-2 mb-2 cursor-pointer"><input type="checkbox" class="inp-check w-5 h-5 accent-brand-600" checked><span class="text-xs font-black text-slate-600 uppercase">${d.label}</span></label>${inputEl}`;
                mInputs.appendChild(div);
            });
        }

        // æ›´æ–°ç¼–è¾‘å™¨
        function updateEditor() {
            // è·å–åŸºç¡€æ–‡æœ¬ï¼ˆé»˜è®¤ç‰ˆæœ¬æˆ–ä¿å­˜çš„ç‰ˆæœ¬ï¼‰
            let baseText = currentPromptDefaultText;
            if (mVersionSelect.value !== 'default') {
                const savedVersion = localStorage.getItem(`tpe_prompt_${currentPromptId}_${mVersionSelect.value}`);
                if (savedVersion) baseText = savedVersion;
            }

            // ä»åŸºç¡€æ–‡æœ¬å¼€å§‹ï¼Œåº”ç”¨å˜é‡æ›¿æ¢
            let text = baseText;

            document.querySelectorAll('.inp-group').forEach(g => {
                const key = g.dataset.key;
                const checkbox = g.querySelector('.inp-check');
                const input = g.querySelector('.inp-val');
                const checked = checkbox ? checkbox.checked : false;
                const val = input ? input.value : '';

                // ä¿å­˜è¾“å…¥å€¼åˆ°localStorage
                localStorage.setItem(`tpe_var_${key}`, val);

                // å®šä¹‰åŒ¹é…æ¨¡å¼
                const patterns = {
                    ticker: /\[\[?Ticker\]?\]|\[è‚¡ç¥¨æ ‡çš„ticker\]|\[è‚¡ç¥¨æ ‡çš„\]|\[Target Ticker\]|\[ä»£ç \]/gi,
                    price: /\[Price Data\]|\[Current Price Data\]|\[å½“å‰ä»·æ ¼[^\]]*\]|\[å½“å‰ä»·æ ¼\/å¸‚å€¼\]|\[Price\]|\[Total Net Worth\]|\[Result\]/gi,
                    sentiment: /\[Market Sentiment\]|\[å¸‚åœºæƒ…ç»ª\]|\[å®è§‚ç¯å¢ƒ\]|\[Macro Context\]|\[Sentiment\]/gi,
                    event: /\[Event\]|\[Event Content\]|\[äº‹ä»¶è¯¦æƒ…\]|\[äº‹ä»¶å†…å®¹\]|\[äº‹ä»¶\/ç ”æŠ¥å†…å®¹\]|\[Macro Event\]|\[å®è§‚äº‹ä»¶\]/gi,
                    context: /\[Context\]|\[Knowledge Base Summary\]|\[Knowledge Base\]|\[çŸ¥è¯†åº“å†…å®¹\]|\[æŒä»“æ•°æ®\]|\[äº¤æ˜“è¯¦æƒ…\]|\[æ“ä½œæ„å›¾ä¸ç†ç”±\]|\[æŒä»“æƒ…å†µ\]|\[Current Portfolio\]|\[Original Thesis\]|\[Holdings\]/gi,
                    notes: /\[Notes\]|\[Additional Notes\]|\[è¡¥å……è¯´æ˜\]|\[Objective\]|\[Exit Reason\]/gi,
                    strategy: /\[Strategy\]|\[Current Strategy\]/gi,
                    action: /\[Action\]|\[Intended Action\]/gi,
                    reason: /\[Reason\]|\[Reasoning\]/gi
                };
                const pattern = patterns[key] || new RegExp(`\\[${key}\\]`, 'gi');

                if (checked && val.trim()) {
                    // å‹¾é€‰ä¸”æœ‰å€¼ï¼šæ›¿æ¢å ä½ç¬¦ï¼Œå¹¶ä¿ç•™æ–¹æ‹¬å·æ ¼å¼ [Value]
                    text = text.replace(pattern, `[${val}]`);
                } else if (!checked) {
                    // æœªå‹¾é€‰ï¼šåˆ é™¤ User Input ä¸­åŒ…å«è¯¥å˜é‡çš„æ•´è¡Œ (åŒ¹é…æ•°å­—å¼€å¤´çš„åˆ—è¡¨é¡¹)
                    const lineRegex = new RegExp(`^\\d+\\..*(?:${pattern.source}).*$(\\r?\\n)?`, 'gmi');
                    text = text.replace(lineRegex, '');
                }
            });

            // ä¿®å¤åºå·é€»è¾‘ï¼šé‡æ–°å¯¹åˆ—è¡¨è¡Œè¿›è¡Œç¼–å·
            let listCounter = 0;
            text = text.split(/\r?\n/).map(line => {
                if (/^\d+\./.test(line)) {
                    listCounter++;
                    return line.replace(/^\d+\./, `${listCounter}.`);
                } else {
                    if (line.trim() !== '') listCounter = 0;
                    return line;
                }
            }).join('\n');

            mEditor.value = text;
        }

        // ç‰ˆæœ¬ç®¡ç†
        function loadVersionList() {
            mVersionSelect.innerHTML = '<option value="default">é»˜è®¤ç‰ˆæœ¬</option>';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i), prefix = `tpe_prompt_${currentPromptId}_`;
                if (key.startsWith(prefix)) {
                    const v = key.substring(prefix.length);
                    mVersionSelect.innerHTML += `<option value="${v}">ğŸ“Œ ${v}</option>`;
                }
            }
            mDeleteVersionBtn.classList.toggle('hidden', mVersionSelect.value === 'default');
        }

        function saveVersion() {
            const name = prompt('è¯·è¾“å…¥ç‰ˆæœ¬åç§°ï¼š', `v${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}`);
            if (!name) return;
            localStorage.setItem(`tpe_prompt_${currentPromptId}_${name}`, mEditor.value);
            loadVersionList(); mVersionSelect.value = name;
            showFeedback('ç‰ˆæœ¬å·²ä¿å­˜ï¼');
        }

        function deleteVersion() {
            const v = mVersionSelect.value; if (v === 'default') return;
            if (confirm(`ç¡®å®šåˆ é™¤ç‰ˆæœ¬ "${v}" å—ï¼Ÿ`)) {
                localStorage.removeItem(`tpe_prompt_${currentPromptId}_${v}`);
                loadVersionList(); mVersionSelect.value = 'default'; updateEditor();
                showFeedback('ç‰ˆæœ¬å·²åˆ é™¤');
            }
        }

        function showFeedback(msg) { mCopyFeedback.textContent = msg; mCopyFeedback.style.opacity = '1'; setTimeout(() => mCopyFeedback.style.opacity = '0', 2000); }

        // æ‰“å¼€æ¨¡æ€æ¡†
        function openModal(promptId) {
            const p = findPrompt(promptId); if (!p) return;
            currentPromptId = p.id;
            currentPromptDefaultText = p.text;
            mTitle.innerHTML = `<span class="text-3xl mr-3">${p.icon}</span><span class="underline decoration-wavy decoration-brand-600">${p.title}</span>`;
            loadVersionList();
            renderModalInputs(p.inputs);
            updateEditor();
            modal.classList.remove('hidden');
        }

        // å¤åˆ¶
        async function copyPrompt() {
            const content = mEditor.value;
            if (!content.trim()) { showFeedback('å†…å®¹ä¸ºç©ºï¼'); return; }
            try {
                await navigator.clipboard.writeText(content);
                showFeedback('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                mCopyBtn.innerHTML = 'âœ… å·²å¤åˆ¶!';
                setTimeout(() => mCopyBtn.innerHTML = 'ğŸ“‹ å¤åˆ¶ Prompt', 2000);
            } catch (e) {
                mEditor.select(); document.execCommand('copy');
                showFeedback('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }
        }

        // åˆå§‹åŒ–
        function init() {
            // ç­‰å¾…PROMPTS_DATAåŠ è½½
            if (!window.PROMPTS_DATA) {
                setTimeout(init, 100);
                return;
            }

            renderNav();
            renderGrid();

            // å¯¼èˆªç‚¹å‡»
            nav.addEventListener('click', e => {
                const btn = e.target.closest('[data-cat]');
                if (btn) { activeCategory = btn.dataset.cat; renderNav(); renderGrid(); }
            });

            // å¡ç‰‡ç‚¹å‡»
            grid.addEventListener('click', e => {
                const card = e.target.closest('[data-prompt-id]');
                if (card) openModal(card.dataset.promptId);
            });

            // æ¨¡æ€æ¡†äº‹ä»¶
            mCloseBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', e => { if (e.target === modal) modal.classList.add('hidden'); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape') modal.classList.add('hidden'); });

            // è¾“å…¥äº‹ä»¶
            document.addEventListener('input', e => { if (e.target.classList.contains('inp-val')) updateEditor(); });
            document.addEventListener('change', e => { if (e.target.classList.contains('inp-check')) updateEditor(); });
            mVersionSelect.addEventListener('change', () => { mDeleteVersionBtn.classList.toggle('hidden', mVersionSelect.value === 'default'); updateEditor(); });

            // ç‰ˆæœ¬æŒ‰é’®
            mSaveVersionBtn.addEventListener('click', saveVersion);
            mResetBtn.addEventListener('click', () => { mVersionSelect.value = 'default'; updateEditor(); showFeedback('å·²é‡ç½®ä¸ºé»˜è®¤ç‰ˆæœ¬'); });
            mDeleteVersionBtn.addEventListener('click', deleteVersion);
            mCopyBtn.addEventListener('click', copyPrompt);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>